#!/bin/bash

# =============================================================================
# SE Notes - Post-commit Hook
# =============================================================================
# Posts commit data to dashcode on localhost:3001 for tracking
# =============================================================================

DASHCODE_URL="http://localhost:3001/api/hooks/report"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get commit information
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_SHORT=$(git rev-parse --short HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -1)
COMMIT_AUTHOR=$(git log -1 --pretty=%an)
COMMIT_EMAIL=$(git log -1 --pretty=%ae)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
REPO_NAME=$(basename "$(git rev-parse --show-toplevel)")
REPO_PATH=$(git rev-parse --show-toplevel)

# Get files changed count
FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l | tr -d ' ')

# Build JSON payload using jq for proper escaping
JSON_PAYLOAD=$(jq -n \
    --arg repoPath "$REPO_PATH" \
    --arg repoName "$REPO_NAME" \
    --arg commitHash "$COMMIT_HASH" \
    --arg branch "$BRANCH" \
    --arg author "$COMMIT_AUTHOR" \
    --arg email "$COMMIT_EMAIL" \
    --arg message "$COMMIT_MESSAGE" \
    --arg shortHash "$COMMIT_SHORT" \
    --argjson filesChanged "$FILES_CHANGED" \
    '{
        repoPath: $repoPath,
        repoName: $repoName,
        commitHash: $commitHash,
        branch: $branch,
        trigger: "post-commit",
        status: "success",
        durationMs: 100,
        meta: {
            author: $author,
            email: $email,
            message: $message,
            shortHash: $shortHash,
            filesChanged: $filesChanged
        },
        results: [
            {
                type: "commit",
                status: "pass",
                output: ("Commit " + $shortHash + " by " + $author),
                durationMs: 100,
                exitCode: 0
            }
        ]
    }')

# Post to dashcode
echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  Dashcode Tracking${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# Check if dashcode is reachable
if curl -s --connect-timeout 2 "http://localhost:3001" > /dev/null 2>&1; then
    # Send the commit data
    RESPONSE=$(curl -s -w "\n%{http_code}" \
        -X POST \
        -H "Content-Type: application/json" \
        -d "$JSON_PAYLOAD" \
        --connect-timeout 5 \
        --max-time 10 \
        "$DASHCODE_URL" 2>&1)
    
    HTTP_CODE=$(echo "$RESPONSE" | tail -1)
    BODY=$(echo "$RESPONSE" | sed '$d')
    
    if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "201" ]]; then
        echo -e "  ${GREEN}✓${NC} Commit tracked successfully"
        echo -e "  ${GREEN}→${NC} $COMMIT_SHORT: $COMMIT_MESSAGE"
    else
        echo -e "  ${YELLOW}⚠${NC} Failed to track commit (HTTP $HTTP_CODE)"
        echo -e "  ${YELLOW}→${NC} Response: $BODY"
    fi
else
    echo -e "  ${YELLOW}⚠${NC} Dashcode not reachable at localhost:3001"
    echo -e "  ${YELLOW}→${NC} Commit recorded locally: $COMMIT_SHORT"
fi

echo ""

# Always exit 0 - post-commit should never block
exit 0
